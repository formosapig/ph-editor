<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ™‚ç©ºå› æžœçŸ©é™£</title>
  <!--<link rel="stylesheet" href="[[ url_for('static', filename='style.css') ]]" />-->
  <link rel="stylesheet" href="[[ url_for('static', filename='theme.css') ]]" />
  <link rel="stylesheet" href="[[ url_for('static', filename='animations.css') ]]" />
  <link rel="stylesheet" href="[[ url_for('static', filename='ccm.css') ]]" />
  <script src="[[ url_for('static', filename='petite-vue.iife.js') ]]" defer></script>
  <script>
    window.rawData = {
      profiles: [[ profiles | tojson ]],
      scenarios: [[ scenarios | tojson ]],
      metadatas: [[ metadatas | tojson ]],
      tag_styles: [[ tag_styles | tojson ]],
      tag_list: [[ tag_list | tojson ]],
      profile_group: [[ profile_group | tojson ]]
    };
  </script>
</head>
<body>
  <div v-scope v-cloak class="page-wrapper">
    <div class="table-container">
      <table>
      
        <!-- table head -->
        <thead>
          <tr>
            <th class="corner-cell">è§’è‰² \ å¹´ä»½</th>
            <th v-for="year in sortedYears" :key="year" class="year-header">
              {{ year }}
            </th>
          </tr>
        </thead>
        
        <!-- table body -->
        <tbody v-for="group in sortedGroups" :key="group.id">
          
          <!-- æœ€å·¦åˆ—, äººç‰©, å«ç¾¤çµ„åŠŸèƒ½ -->
          <tr class="group-header-row" @click="toggleGroup(group.id)">
            <td :colspan="sortedYears.length + 1" :style="{ borderLeft: '8px solid ' + group.color}">
              <div class="group-title-content">
                <span class="collapse-icon">{{ isCollapsed(group.id) ? 'â–¶' : 'â–¼' }}</span>
                <span class="group-name" :style="{ color: group.color }">{{ group.name.zh }}</span>
                <span class="group-desc" v-if="!isCollapsed(group.id)">â€” {{ group.desc.zh }}</span>
                <span class="group-count" v-else>({{ getProfilesByGroup(group.id).length }})</span>
              </div>
            </td>
          </tr>
          
          <!-- scenario box -->
          <tr v-for="p in getProfilesByGroup(group.id)" 
              v-show="!isCollapsed(group.id)" 
              :key="p['!id']"
              class="matrix-row">
              
            <!-- è§’è‰²å–”... -->  
            <td class="fixed-col" :style="{ borderLeft: '8px solid ' + p.groupColor, backgroundColor: p.groupBg }">
              <div class="profile-cell-wrapper">
                <div class="p-name">{{ p.name }} <span class="p-born">({{ p.born }})</span></div>
                <div class="p-stats">{{ p.height }}cm / {{ p.cup }}</div>
              </div>
            </td>
            
            <!-- å ´æ™¯å”· -->
            <td v-for="year in sortedYears" :key="year" class="matrix-cell">
              <div v-for="sc in getScenariosByYearAndProfile(p['!id'], year)" 
                   :key="sc.id" class="event-box"
                   @click="toggleLock(sc.id)"
                   :class="{ 'active-link': hoveredScenarioId === sc.id, 'locked': isLocked && hoveredScenarioId === sc.id }"
                   :style="getScenarioStyle(sc.id, p['!id'])"
                   @mouseenter="handleMouseEnter(sc.id)"
                   @mouseleave="handleMouseLeave()">
                
                <!-- å ´æ™¯æ¨™é¡Œ -->   
                <div class="sc-name" :style="getScenarioTitleStyle(sc.id, p['!id'])">{{ sc.title }}</div>
                
                <!-- å ´æ™¯åƒèˆ‡è€…çš„ tag -->
                <div class="tags-container">
                  <div v-for="bg in getBackstagesByScenario(sc.id)" :key="version + '_' + bg.id" style="display: contents">
                    <div v-if="getTagInfo(bg.tag_id)" class="sc-tag"
                         :style="{ 
                           color: getTagInfo(bg.tag_id).style.color, 
                           background: getTagInfo(bg.tag_id).style.background,
                           border: '1px solid ' + getTagInfo(bg.tag_id).style.color
                         }"
                         :class="{ 'tag-active': bg.profile_id === p['!id'], 'tag-dimmed': bg.profile_id !== p['!id'] }">
                      {{ getTagInfo(bg.tag_id).name.zh }}
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <!-- æµ®å‹• Plot -->	
    <div v-if="hoveredTitle || basePlot"
         class="plot-tooltip"
         :class="{ 'is-locked': isLocked }"
         @mouseleave="onTooltipMouseLeave">
      
      <!-- Plot é é¢æ¨™é¡Œ -->
      <header class="clickable" @click.stop="toggleLockOnHeader()">
        <div>
          <span v-if="isLocked" class="pin">ðŸ“Œ</span> {{ hoveredTitle }}
        </div>
        <span v-if="hoveredYear" class="header-year">ðŸ“… {{ hoveredYear }}</span>
      </header>

      <!-- Plot å…§å®¹ -->
      <main>
      
        <!-- åŠ‡æƒ…å…§å®¹ -->
        <article>{{ basePlot }}</article>

        <!-- åŠ‡æƒ…åƒèˆ‡è€… -->
        <section v-for="char in hoveredCharacters">

          <hr> <!-- åˆ†éš”ç·š -->

          <!-- è§’è‰²å…§å®¹ -->
          <div class="char-row-container">
            
            <aside><!-- å·¦é‚Š, å°åœ–ç¤ºåŠæ¨™ç±¤ -->
              
              <!-- äººç‰©ç¸®åœ– -->
              <div class="char-avatar-box" @click="openFile(char.fileId)">
                <img :src="char.avatar" @error="(e) => e.target.src='/cache/default.jpg'">
              </div>
              
              <!-- æ¨™ç±¤ -->
              <span v-if="char.tag" class="sc-tag" :style="char.tag?.style">{{ char.tag?.name }}</span>
            </aside>

            <div class="info-summary"><!-- å³é‚Š, äººç‰©ä¸»è¦å±¬æ€§, èªªæ˜Ž -->
        
              <!-- äººç‰©ä¸»è¦å±¬æ€§ -->
              <div class="info-top">
                <span class="char-name-highlight">{{ char.name }}</span>
                <span v-if="char.age" class="char-age-dim"> Â· {{ char.age }}æ­²</span>
                <div v-if="char.persona || char.shadow" style="margin-left: auto; display: flex; gap: 8px;">
                  <template v-if="char.persona">
                    <span>ðŸŽ­</span>
                    <span :style="getBadgeStyle(char.pColor)" class="meta-badge">{{ char.persona }}</span>
                  </template>
                  <template v-if="char.shadow">
                    <span>ðŸ‘¤</span>
                    <span :style="getBadgeStyle(char.sColor)" class="meta-badge">{{ char.shadow }}</span>
                  </template>
                </div>
              </div>
              
              <!-- èªªæ˜Ž -->
              <div v-if="char.notes" class="info-bottom">{{ char.notes }}</div>
            </div>
          </div>
        </section>
      </main>
    </div> <!-- end of plot -->
  </div>
  <script src="[[ url_for('static', filename='ccm.js') ]]"></script>
</body>
</html>