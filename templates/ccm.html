<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ™‚ç©ºå› æžœçŸ©é™£</title>
  <link rel="stylesheet" href="[[ url_for('static', filename='style.css') ]]" />
  <link rel="stylesheet" href="[[ url_for('static', filename='ccm.css') ]]" />
  <script src="[[ url_for('static', filename='petite-vue.iife.js') ]]" defer></script>
  <script>
    window.rawData = {
      profiles: [[ profiles | tojson ]],
      scenarios: [[ scenarios | tojson ]],
      metadatas: [[ metadatas | tojson ]],
      tag_styles: [[ tag_styles | tojson ]],
      tag_list: [[ tag_list | tojson ]],
      profile_group: [[ profile_group | tojson ]]
    };
  </script>
</head>
<body>
  <div v-scope v-cloak class="page-wrapper">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="corner-cell">è§’è‰² \ å¹´ä»½</th>
            <th v-for="year in sortedYears" :key="year">
              <div class="year-header">{{ year }}</div>
            </th>
          </tr>
        </thead>
        <tbody v-for="group in sortedGroups" :key="group.id">
          <tr class="group-header-row" @click="toggleGroup(group.id)">
            <td :colspan="sortedYears.length + 1" :style="{ borderLeft: '8px solid ' + group.color}">
              <div class="group-title-content">
                <span class="collapse-icon">{{ isCollapsed(group.id) ? 'â–¶' : 'â–¼' }}</span>
                <span class="group-name" :style="{ color: group.color }">{{ group.name.zh }}</span>
                <span class="group-desc" v-if="!isCollapsed(group.id)">â€” {{ group.desc.zh }}</span>
                <span class="group-count" v-else>({{ getProfilesByGroup(group.id).length }})</span>
              </div>
            </td>
          </tr>
          <tr v-for="p in getProfilesByGroup(group.id)" 
              v-show="!isCollapsed(group.id)" 
              :key="p['!id']"
              class="matrix-row">
            <td class="fixed-col" :style="{ borderLeft: '8px solid ' + p.groupColor, backgroundColor: p.groupBg }">
              <div class="profile-cell-wrapper">
                <div class="p-name">{{ p.name }} <span class="p-born">({{ p.born }})</span></div>
                <div class="p-stats">{{ p.height }}cm / {{ p.cup }}</div>
              </div>
            </td>
            <td v-for="year in sortedYears" :key="year" class="matrix-cell">
              <div v-for="sc in getScenariosByYearAndProfile(p['!id'], year)" 
                   :key="sc.id" class="event-box"
                   @click="toggleLock(sc.id)"
                   :class="{ 'active-link': hoveredScenarioId === sc.id, 'locked': isLocked && hoveredScenarioId === sc.id }"
                   :style="getScenarioStyle(sc.id, p['!id'])"
                   @mouseenter="handleMouseEnter(sc.id)"
                   @mouseleave="handleMouseLeave()">
                <div class="sc-name" :style="getScenarioTitleStyle(sc.id, p['!id'])">{{ sc.title }}</div>
                <div class="tags-container">
                  <div v-for="bg in getBackstagesByScenario(sc.id)" :key="version + '_' + bg.id" style="display: contents">
                    <div v-if="getTagInfo(bg.tag_id)" class="sc-tag"
                         :style="{ 
                           color: getTagInfo(bg.tag_id).style.color, 
                           background: getTagInfo(bg.tag_id).style.background,
                           border: '1px solid ' + getTagInfo(bg.tag_id).style.color
                         }"
                         :class="{ 'tag-active': bg.profile_id === p['!id'], 'tag-dimmed': bg.profile_id !== p['!id'] }">
                      {{ getTagInfo(bg.tag_id).name.zh }}
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- æµ®å‹• pilot -- >	
    <div v-if="hoveredPlot" class="plot-tooltip">
      <div class="tooltip-header">
        <div class="header-left">
          <span v-if="isLocked">ðŸ“Œ</span> {{ hoveredTitle }}
        </div>
        <span v-if="hoveredYear" class="header-year">ðŸ“… {{ hoveredYear }}</span>
      </div>
      <div class="tooltip-body" v-html="hoveredPlot"></div>
      <!--<div class="tooltip-body">{{ hoveredPlot }}</div>-- >
    </div>-->
    
    <div v-if="hoveredTitle || basePlot" class="plot-tooltip" :class="{ 'is-locked': isLocked }" @mouseleave="onTooltipMouseLeave">
  <div class="tooltip-header clickable" @click.stop="toggleLockOnHeader()">
    <div class="header-left">
      <span v-if="isLocked">ðŸ“Œ</span> {{ hoveredTitle }}
    </div>
    <span v-if="hoveredYear" class="header-year">ðŸ“… {{ hoveredYear }}</span>
  </div>

  <div class="tooltip-body">
    <div style="white-space: pre-wrap; margin-bottom: 8px;">{{ basePlot }}</div>

    <div v-for="char in hoveredCharacters" class="char-entry">
  <hr class="char-divider">
  
  <div class="char-row-container">
  <!--
    <div class="char-avatar-box clickable" @click="openFile(char.fileId)">
      <img :src="char.avatar" class="char-thumb" @error="(e) => e.target.src='/cache/default.jpg'">
    </div>-->

<div class="char-left-column">
    
    <div class="char-avatar-box clickable" @click="openFile(char.fileId)">
      <img :src="char.avatar" class="char-thumb" @error="(e) => e.target.src='/cache/default.jpg'">
    </div>

    <div v-if="char.tag" style="margin-top: -10px; z-index: 10; pointer-events: none;">
      <span class="sc-tag" :style="char.tag?.style">{{ char.tag?.name }}</span>
    </div>
  </div>
  

    <div class="char-main-info">
      <div class="info-top">

        <span class="char-name-highlight">{{ char.name }}</span>
        <span v-if="char.age" class="char-age-dim"> Â· {{ char.age }}æ­²</span>
        
        <div v-if="char.persona || char.shadow" style="margin-left: auto; display: flex; gap: 8px;">
        <template v-if="char.persona">
          <span class="meta-emoji">ðŸŽ­</span>
          <span :style="getBadgeStyle(char.pColor)" class="meta-badge">{{ char.persona }}</span>
        </template>
        <template v-if="char.shadow">
          <span class="meta-emoji">ðŸ‘¤</span>
          <span :style="getBadgeStyle(char.sColor)" class="meta-badge">{{ char.shadow }}</span>
        </template>
        </div>
        
        
      </div>

      <div v-if="char.notes" class="info-bottom char-notes-text">{{ char.notes.trim() }}</div>
    </div>
  </div>
  
  
  
</div>


  </div>
</div>
    
    
  </div>
  <script src="[[ url_for('static', filename='ccm.js') ]]"></script>
</body>
</html>